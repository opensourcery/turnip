#!/bin/bash
#
# Runs site-install from drush then enables some local modules
#
# To use this command you must have Drush installed.
#
source bin/.config

# Run the rebuild script.
bin/rebuild

if ! ( test -e drupal ); then
  echo "I didn't find a drupal directory. Are you sure it exists?"
  exit 1
fi

# Site install.
if [[ -e db/production_current.sql.gz ]]; then
  cd db
  ./db_load.sh production_current.sql.gz
  cd -
else
  cd drupal
  drush site-install -y --uri=default $PROFILE
  drush fra -y
  drush cc all
  cd -
fi

# Enable modules I use locally every time.
# TODO read this from local config instead of hard-coding.
# TODO use drush aliases
cd drupal
drush en diff -y
drush en views_ui -y
drush en styleguide -y
cd -

# Run behat.
cd bdd
# Check for composer, or install
composer=`command -v composer > /dev/null 2>&1`
if [[ composer -eq 0 ]]; then
  # Install locally.
  if [[ ! -e composer.phar ]]; then
    curl -sS https://getcomposer.org/installer | php
  fi
  composer_command=./composer.phar
else
  composer_command=composer
fi

if [[ ! -e bin/behat ]]; then
  $composer_command install
fi

if [[ -e behat.local.yml ]]; then
  bin/behat
else
  echo "Cannot run behat tests until bdd/behat.local.yml exists! Copy bdd/behat.local.yml.example into place to get started."
fi
